<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hasil Laporan SAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-4">

    <!-- Judul -->
    <h3 class="mb-4">ðŸ“Š Visualisasi Total of Reporting Period</h3>

    <!-- Chart Canvas -->
    <canvas id="barChart" height="100"></canvas>

    <hr class="my-5">
    <h5>ðŸ“ˆ Pie Chart: Proporsi Total of Reporting Period</h5>
    <canvas id="pieChart" height="100"></canvas>

    <!-- Tabel hasil parsing -->
    <h5>ðŸ“‹ Tabel Data Laporan SAP (yang sudah dirapikan)</h5>
    <div class="table-responsive mb-5">
      {{ table | safe }}
    </div>

    <!-- Form pembagian otomatis -->
    <hr>
    <h5>Pembagian Otomatis Berdasarkan Porsi</h5>
    <form method="POST" action="/calculate/">
      <input type="hidden" name="total_laba" value="{{ total }}">
      <div class="row">
        <div class="col-md-6">
          <label>Porsi Entitas A (%)</label>
          <input type="number" class="form-control" name="porsi_a" value="60" required>
        </div>
        <div class="col-md-6">
          <label>Porsi Entitas B (%)</label>
          <input type="number" class="form-control" name="porsi_b" value="40" required>
        </div>
      </div>
      <button class="btn btn-success mt-3">Hitung Pembagian</button>
    </form>

  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Chart Bar Script -->
  <script>
    (function () {
      let chartLabels = JSON.parse('{{ labels | tojson | safe }}');
      let chartValues = JSON.parse('{{ values | tojson | safe }}');
      let chartColors = JSON.parse('{{ colors | tojson | safe }}');

      const ctx = document.getElementById('barChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Total of Reporting Period',
            data: chartValues,
            backgroundColor: chartColors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return 'Rp ' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: function (value) {
                  return 'Rp ' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    })();
  </script>
<!-- Chart Pie Script -->
<script>
  (function () {
    let chartLabels = JSON.parse('{{ labels | tojson | safe }}');
    let chartValues = JSON.parse('{{ values | tojson | safe }}');
    let chartColors = JSON.parse('{{ colors | tojson | safe }}');
    let pieColors = JSON.parse('{{ pie_colors | tojson | safe }}');

    let ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Total of Reporting Period',
          data: chartValues,
          backgroundColor: chartColors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function (context) {
                return 'Rp ' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: function (value) {
                return 'Rp ' + value.toLocaleString();
              }
            }
          }
        }
      }
    });

    // PIE CHART
    let ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: chartLabels,
        datasets: [{
          data: chartValues,
          backgroundColor: pieColors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right'
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                return context.label + ': Rp ' + context.parsed.toLocaleString();
              }
            }
          }
        }
      }
    });

  })();
</script>
<a href="/upload/logs" class="btn btn-outline-dark">Lihat Audit Log</a>
</body>
</html>
